.. sectnum::

=============
Release Notes
=============
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
GroupServer 12.11 — Absinthe Acquired Arbitrarily
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

:Authors: `Michael JasonSmith`_; `Richard Waid`_; `Dan Randow`_
:Contact: Michael JasonSmith <mpj17@onlinegroups.net>
:Date: 2012-11-12
:Organization: `GroupServer.org`_
:Copyright: This document is licensed under a
  `Creative Commons Attribution-Share Alike 3.0 New Zealand License`_
  by `OnlineGroups.Net`_.

.. contents::

------------
Introduction
------------

There are fourteen major `changes to GroupServer`_ in the Absinthe release
— making the system more useful, usable and extensible for both group
members, administrators, and developers. You can `get Absinthe`_
immediately.

Acknowledgements
================

----------------------
Changes to GroupServer
----------------------

The `changes visible to participants`_ are mostly subtle improvements to
existing features, rather than new features. In contrast, the `changes to
the underlying system`_ are complex and extensive.

Changes Visible to Participants
===============================

The most visible change that is visible to the participants is a `new
search system`_.  Some `better error pages`_ have also been created. To
help participants and administrators there is a `new help system`_, while
an `in-context administration guide`_ will help administrators get their
new group going more easily. Administrators now have the ability to create
`closed groups`_, and the new `profile search`_ will help administrators
find participant's profiles. Finally, `SVG thumbnails`_ are now shown.

New Search System
-----------------

The new search system is the most visible change in Absinthe. 

* The *Topics* tab on both the site homepage and the group page have a
  *Search* entry [#noSearch]_.
* The *Posts* tab in a group has as *Search* entry also, allowing posts to
  be searched [#postSearch]_.
* Clicking a topic keyword will search for other topics with that keyword
  [#clickableKW]_.
* Searching now uses *stems*; searching for ``search`` will match topics
  that contain the words ``searches``, ``searching`` or ``searched``, for
  example.
* Searching is faster, as the full-text retrieval features of PostgreSQL_
  are used [#FTR]_.
* The display of topics in a site or group is much faster, as the keywords
  are now generated when someone posts, rather than when the topic is
  loaded.
* Searching using non-ASCII characters now works [#nonAscii]_.

Better Error Pages
------------------

The *Permission Denied* page has been improved to add some suggestions
about what the participant should do [#forbidden]_. In addition the
``mailto`` that is embedded in the page now includes the URL of the problem
page in the body of the email message to the Support address.

New Help System
---------------

The old monolithic manuals have been replaced. The new more dynamic system
will automatically show help for the features that are installed in
GroupServer, including the custom features. Some of the old pages have been
retained and updated.

In-Context Administration Guide
-------------------------------

To help get groups started there is a new system to encourage the group
administrator along the way [#encouragement]_. The current advice includes:

* Start a topic
* Invite people, 
* Write some text in the *About* tab, and
* Make a group Private (rather than Secret).


Closed Groups
-------------

Administrators can now close groups [#closed]_. There are two reasons for this. 

#. The group may be *starting*, and the administrator does not want the
   members to post until everyone is in the group.
#. The group may be *finished*, and the administrator does not want any
   more posts to be made, but he or she still wants the archive available.

While there is no front-end user interface that allows the group-type to be
changed, an administrator can change the type of the group by making a
change in the ZMI.

Profile Search
--------------

A simple profile search has been added [#profileSearch]_. A more complex
search system has not been added because the privacy issues are still being
resolved.

SVG Thumbnails
--------------

Thanks to `Bill Bushey`_, GroupServer now correctly displays a thumbnail of
an SVG image [#svg]_.

Changes to the Underlying System
================================

We have made significant changes to the underlying GroupServer system in
the Absinthe release. The system will be easier to maintain because of a
new `configuration system`_, `improved email handling`_, and a `new
authentication system`_. Installation is simpler because `relstorage`_ is
used by default. There have also been some significant `performance
improvements`_. Developers will notice the `SQLAlchemy update`_, and a
`more flexible group page`_.

The changes to the underlying system have been so extensive that we have
decided to change the naming scheme for the GroupServer releases. The new
releases belong to the **Awesome Aperitifs** series. Hence this *Absinthe
Acquired Arbitrarily* release. Internally, the eggs in this series are
given the version 2.0 (which you can see by looking at the ``versions.cfg``
file in the build directory). The version-number of the *release* will
continue to use the ``month.day`` format. The old series was known as
**Frozen Treats**; *Faloodeh Consumed with an Eye on History* was the
aptly-named last release in that series. (Eggs in the Frozen Treats series
were given the 1.0 version.)

Configuration System
--------------------

Administration is now simpler, especially for production systems, as the
configuration for important parts of GroupServer are now in a file that is
external to the ZODB. The new configuration system handles the database,
the `improved email handling`_, and the `new authentication system`_. It is
based on a INI file, located in ``parts/instance/gsconfig.ini``.

Improved Email Handling
-----------------------

The email-handling subsystem of GroupServer has been completely
rewritten. Changes have been made to both the handling of outgoing mail and
incoming mail.

The setup for the **outgoing** SMTP system has moved from the ZODB
(accessed through the ZMI) to an INI file [#mailhost]_, thanks to the new
`configuration system`_. Documentation for the new outgoing SMTP system can
be found in `the README for the gs.email product`_.

The script that is used to add email messages to a group, the **incoming**
SMTP system, has been rewritten [#smtp2gs]_. It is now easier to use,
better documented, and works. Documentation for the new script can be found
by running ``./bin/smtp2gs -h`` or reading `the README for the
gs.group.messages.add.smtp2gs product`_.

New Authentication System
-------------------------

A new authentication system has been created, for the server-side scripts
[#auth]_. These scripts, such as the those involved in the `improved email
handling`_, now pass a *token* to the server when they carry out
tasks. This eliminates the need to store the password of the administrator
in various plain-text files.

Relstorage
----------

By default `the Relstorage product`_ is now used to store the ZODB. This
system stores the pickled objects in a relational database, rather than in
the file-system. (The PostgreSQL_ database is used by GroupServer.) This
allows greater scalability, without the need to separately install Zope
Enterprise Objects (ZEO).

Performance Improvements
------------------------

There have been some major performance improvements made to GroupServer in
the Absinthe release. This includes the removal of some old poorly
performing code [#divisionObject]_, and altering some of the member
management code [#members]_.

SQLAlchemy Update
------------------

The entire interface between GroupServer and the PostgreSQL_ relational
database has been rewritten [#dbError]_. This has allowed GroupServer to
update its SQLAlchemy_ dependency from the ancient 0.3 release to the
current 0.7 release.


More Flexible Group Page
------------------------

The group page was refactored to make it more flexible [#groupHome]_. This
allows the addition of the `in-context administration guide`_, and for
other features to be added by skins.

------------
Get Absinthe
------------

To get Absinthe go to `the Downloads page for GroupServer`_ and follow `the
GroupServer Installation documentation`_. Those who already have a
functioning installation can `update an existing GroupServer system`_.


Update an Existing GroupServer System
=====================================

Updating a system running the Faloodeh release of GroupServer (12.06) to
Absinthe is a three-step process, which includes updating the `relational
database`_, the `products`_, and the `scripts`_.

Relational Database
-------------------

The biggest change that is needed to update GroupServer to the Absinthe
release is to update the rational database, to support the `new search
system`_ and some of the `performance improvements`_. The tables that are
used to store the `posts`_, `topics`_ and `topic keywords`_ all need to be
updated.

Posts
~~~~~

Begin by updating the table that stores the posts.

#.  Log in to the PostgreSQL_ command line::
   
      $ psql -hlocahlost -Ugsadmin groupserver

    Where ``gsadmin`` is the PostgreSQL user that you set up when
    installing GroupServer, and ``groupserver`` is the name of the
    database.

#.  Alter the ``post`` table to add the full-text retrieval (FTR, or
    full-text search, FTS) column, by executing the following SQL::

     ALTER TABLE post ADD COLUMN fts_vectors tsvector;

#.  Update the rows of the ``post`` table to add the FTR data. This will
    take some time::

     UPDATE post 
     SET fts_vectors = to_tsvector('english', left(coalesce(subject,'') || ' ' || coalesce(body, ''), 1048575));

#.  Create an index for the FTR data. This will take some time::

      CREATE INDEX post_fts_vectors ON post USING gin(fts_vectors);

#.  Create an index for the posts, sorted by the last post date::

      CREATE INDEX post_last_post_date_idx ON post (date DESC);

#.  Create a trigger to update the FTR data whenever a new post is made::

      CREATE TRIGGER fts_vectors_update 
        BEFORE INSERT or UPDATE ON post 
        FOR EACH ROW EXECUTE PROCEDURE 
          tsvector_update_trigger(fts_vectors, 'pg_catalog.english', subject, body);

Topics
~~~~~~

Because people search topics as well as posts the FTR information needs to
be present in both tables.

#.  Add the FTR column to the ``topic`` table::

      ALTER TABLE topic ADD COLUMN fts_vectors tsvector;

#.  Drop the old tables that were used for searching::

      DROP TABLE topic_word_count;
      DROP TABLE word_count;

    Even with the FTR data duplicated in the ``post`` and ``topic`` table,
    there is a nett saving of space once these two tables are dropped.

#.  Add the function that is used to create the *body* of the topic::

      CREATE OR REPLACE FUNCTION topic_body (topic_id TEXT)
        RETURNS TEXT AS $$
        DECLARE
            topic_text TEXT;
            subject TEXT;
            retval TEXT;
        BEGIN
          SELECT string_agg(post.body, ' ') INTO topic_text
            FROM post 
            WHERE post.topic_id = topic_body.topic_id
              AND post.hidden IS NULL;
          SELECT COALESCE(post.subject, '') INTO subject
            FROM post WHERE post.topic_id = topic_body.topic_id LIMIT 1;
          retval := left(subject || ' ' || topic_text, 1048575);
          RETURN retval;
        END;
      $$ LANGUAGE 'plpgsql';

#.  Create the function that will ``topic`` table with FTR data::

      CREATE OR REPLACE FUNCTION topic_ftr_populate () 
        RETURNS void AS $$ 
          DECLARE
            total_topics REAL;
            trecord RECORD;
            topic_vector tsvector;
            topic_text TEXT;
            i REAL DEFAULT 0;
            p REAL;
          BEGIN
            SELECT CAST(total_rows AS REAL) INTO total_topics
              FROM rowcount WHERE table_name = 'topic';
            FOR trecord IN SELECT * FROM topic WHERE fts_vectors IS NULL LOOP
              RAISE NOTICE 'Topic %', trecord.topic_id;
              topic_vector := to_tsvector('english', topic_body(trecord.topic_id));
              UPDATE topic SET fts_vectors = topic_vector 
                WHERE topic.topic_id = trecord.topic_id;
              i := i + 1;
              p := (i / total_topics) * 100;
              RAISE NOTICE '  Progress % %%', p;
            END LOOP;
          END;
      $$ LANGUAGE 'plpgsql';

#.  Populate the ``topic`` table with FTR data. This will take some time::

      SELECT topic_ftr_populate();

#.  Create an index for the FTR data. This will take some time::

      CREATE INDEX topic_fts_vectors ON topic USING gin(fts_vectors);

#.  Create an index for the topics, sorted by the last post date::

      CREATE INDEX topic_last_post_date_idx ON topic (last_post_date DESC);

#.  Create a trigger to update the FTR data whenever a new *post* is made::

      CREATE OR REPLACE FUNCTION topic_fts_update ()
        RETURNS TRIGGER AS $$
          DECLARE
            topic_text TEXT;
          BEGIN
            topic_text := topic_body(NEW.topic_id);
            NEW.fts_vectors := to_tsvector('english', topic_text);
            RETURN NEW;
          END;  
      $$ LANGUAGE 'plpgsql';
      CREATE TRIGGER topic_update_trigger_01
        BEFORE INSERT OR UPDATE ON topic
        FOR EACH ROW EXECUTE PROCEDURE topic_fts_update ();

Topic Keywords
~~~~~~~~~~~~~~

Finally, the system that displays the topic keywords has been changed. The
keywords are now calculated when someone posts, and are stored in the
``topic_keywords`` table. Previously they were calculated when the list of
topics was displayed.

#.  Download the file `03-keywords.sql
    <https://source.iopen.net/groupserver/gs.group.messages.topic/rawfile/78cf038e3c86b6df0a7dbf2f4950f8438ac72e8e/gs/group/messages/topic/sql/03-keywords.sql>`_.
    This contains the SQL that is normally executed when Absinthe is
    installed.

#.  Interpret (execute) the file in PostgreSQL::

      \i /path/to/the/download/03-keywords.sql

    Where ``/path/to/the/download`` is the full path to where the file
    ``03-keywords.sql`` is stored.

#.  Create the function to populate the new ``topic_keywords`` table::

      CREATE OR REPLACE FUNCTION topic_keywords_populate () 
        RETURNS void AS $$ 
          DECLARE
            total_topics REAL;
            trecord RECORD;
            topic_text TEXT;
            new_keywords TEXT[];
            i REAL DEFAULT 0;
            p REAL;
          BEGIN
            SELECT CAST(total_rows AS REAL) INTO total_topics
              FROM rowcount WHERE table_name = 'topic';
            FOR trecord IN SELECT * FROM topic LOOP
              RAISE NOTICE 'Topic %', trecord.topic_id;
              topic_text = topic_body(trecord.topic_id);
              SELECT ARRAY(SELECT word 
                             FROM topic_keywords(trecord.topic_id, topic_text))
                INTO new_keywords;
              INSERT INTO topic_keywords VALUES(NEW.topic_id, new_keywords);
              i := i + 1;
              p := (i / total_topics) * 100;
              RAISE NOTICE '  Progress % %%', p;
            END LOOP;
          END;
      $$ LANGUAGE 'plpgsql';

#.  Populate the ``topic_keywords`` table. This will take some time::

      SELECT topic_keywords_populate();

Products
--------

Scripts
-------

---------
Resources
---------

- Code repository: https://source.iopen.net/groupserver/
- Questions and comments to http://groupserver.org/groups/development
- Report bugs at https://redmine.iopen.net/projects/groupserver

.. [#noSearch] The *Search* box that used to appear on every page has now
               been removed, as it is easier to use the *Search* entry in
               the *Topics* tab. This closes `Bug 3434`_.
.. _Bug 3434: https://redmine.iopen.net/issues/3434
.. [#postSearch] Searching in posts closes `Feature 3497`_.
.. _Feature 3497: https://redmine.iopen.net/issues/3497
.. [#clickableKW] Creating topic keywords that can be clicked closes
                  `Feature 878`_.
.. _Feature 878: https://redmine.iopen.net/issues/878
.. [#FTR] Using the full-text retrieval feature of PostgreSQL_ closes
          `Feature 224`_.
.. _Feature 224: https://redmine.iopen.net/issues/224
.. [#nonAscii] Being able to search for non-ASCII characters closes `Bug 603`_.
.. _Bug 603: https://redmine.iopen.net/issues/603
.. [#forbidden] Updating the *Permission Denied* page closes `Bug 646`_.
.. _Bug 646: https://redmine.iopen.net/issues/646
.. [#encouragement] Creating the encouragement closes `Feature 3501`_ and
                    `Feature 177`_.
.. _Feature 3501: https://redmine.iopen.net/issues/3501
.. _Feature 177: https://redmine.iopen.net/issues/177
.. [#closed] Creating the closed-group closes `Feature 449`_.
.. _Feature 449: https://redmine.iopen.net/issues/449
.. [#profileSearch] The creation of a basic profile search closes `Feature
                    3486`_.
.. _Feature 3486: https://redmine.iopen.net/issues/3486
.. [#svg] Handling SVG Thumbnails closes `Bug 635`_.
.. _Bug 635: https://redmine.iopen.net/issues/635
.. [#mailhost] Moving the SMTP configuration to an INI file means that the
               two ``MailHost`` instances from the ZODB can be removed,
               which closes `Bug 365`_.
.. _Bug 365: https://redmine.iopen.net/issues/365
.. _The README for the gs.email product:
   https://source.iopen.net/groupserver/gs.email/
.. [#smtp2gs] Rewriting the script that is used to add email messages to a
              group closes `Feature 687`_ and `Feature 3536`_.
.. _Feature 687: https://redmine.iopen.net/issues/687
.. _Feature 3536: https://redmine.iopen.net/issues/3536
.. _The README for the gs.group.messages.add.smtp2gs product:
   https://source.iopen.net/groupserver/gs.group.messages.add.smtp2gs/
.. [#auth] The creation of a new authentication system closes `Bug 3416`_.
.. _Bug 3416:  https://redmine.iopen.net/issues/3416
.. _Feature 279: https://redmine.iopen.net/issues/279
.. [#divisionObject] The removal of the old ``division_object`` getter
                     closes `Bug 279`_.
.. _Bug 279: https://redmine.iopen.net/issues/279
.. [#members] The optimisation of the member-handling code closes `Bug
              3659`_.
.. _Bug 3659: https://redmine.iopen.net/issues/3659
.. [#dbError] An unintentional site-effect of rewriting the database
             interface was a fix for `Bug 203`_.
.. _Bug 203: https://redmine.iopen.net/issues/203
.. [#groupHome] As part of the update to the group, `Feature 419`_ was
                closed.
.. _Feature 419: https://redmine.iopen.net/issues/419

..  _GroupServer.org: http://groupserver.org/
..  _OnlineGroups.Net: http://onlinegroups.net/
..  _Creative Commons Attribution-Share Alike 3.0 New Zealand License:
    http://creativecommons.org/licenses/by-sa/3.0/nz/
..  _Michael JasonSmith: http://groupserver.org/p/mpj17
..  _Richard Waid: http://groupserver.org/p/richard
..  _Dan Randow: http://groupserver.org/p/danr
..  _Bill Bushey: http://groupserver.org/p/wbushey
..  _The Downloads page for GroupServer: http://groupserver.org/downloads
..  _The GroupServer Installation documentation: 
    http://groupserver.org/downloads/install
.. _the Relstorage product: http://pypi.python.org/pypi/RelStorage
.. _PostgreSQL: http://postgresql.org
.. _SQLAlchemy: http://www.sqlalchemy.org/
